<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Masque Flou Drag & Drop</title>
<style>
body {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #111;
  color: #fff;
  font-family: sans-serif;
  margin: 0;
  padding: 20px;
}
canvas {
  border: 2px solid #fff;
  touch-action: none;
}
#controls {
  margin: 10px;
}
input, button, select {
  margin: 5px;
  padding: 5px 10px;
  font-size: 16px;
}
button { cursor:pointer; }
</style>
</head>
<body>
<h1>Masque Flou Drag & Drop</h1>
<input type="file" id="upload" accept="image/*">
<div id="controls">
  <label>Forme:
    <select id="shape">
      <option value="rect">Rectangle</option>
      <option value="circle">Cercle</option>
    </select>
  </label>
  <label>Flou:
    <input type="range" id="blurRange" min="0" max="30" value="10">
  </label>
  <button id="increase">Agrandir</button>
  <button id="decrease">Réduire</button>
  <button id="reset">Réinitialiser</button>
  <button id="export">Exporter</button>
</div>
<canvas id="canvas" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const upload = document.getElementById('upload');
const resetBtn = document.getElementById('reset');
const increaseBtn = document.getElementById('increase');
const decreaseBtn = document.getElementById('decrease');
const exportBtn = document.getElementById('export');
const shapeSelect = document.getElementById('shape');
const blurRange = document.getElementById('blurRange');

let img = new Image();
let mask = {x:200,y:150,w:400,h:300};
let dragging=false, dragOffsetX, dragOffsetY;

// Charger l'image
upload.addEventListener('change', e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=event=>img.src=event.target.result;
  reader.readAsDataURL(file);
});

// Dessiner image + masque
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(img.src) ctx.drawImage(img,0,0,canvas.width,canvas.height);

  // Effet flou stylé (flou multiple)
  ctx.save();
  ctx.filter=`blur(${blurRange.value}px)`;
  ctx.beginPath();
  if(shapeSelect.value==='rect') ctx.rect(mask.x,mask.y,mask.w,mask.h);
  else ctx.arc(mask.x+mask.w/2,mask.y+mask.h/2,Math.min(mask.w,mask.h)/2,0,Math.PI*2);
  ctx.clip();
  if(img.src){
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    // deuxième passage flou pour effet plus “fort”
    ctx.filter=`blur(${blurRange.value/2}px)`;
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
  }
  ctx.restore();

  // Contour du masque
  ctx.strokeStyle='#0f0';
  ctx.lineWidth=2;
  if(shapeSelect.value==='rect') ctx.strokeRect(mask.x,mask.y,mask.w,mask.h);
  else{
    ctx.beginPath();
    ctx.arc(mask.x+mask.w/2,mask.y+mask.h/2,Math.min(mask.w,mask.h)/2,0,Math.PI*2);
    ctx.stroke();
  }
}

// Drag & Drop
canvas.addEventListener('mousedown', e=>{
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;
  if(shapeSelect.value==='rect' && x>mask.x && x<mask.x+mask.w && y>mask.y && y<mask.y+mask.h){
    dragging=true; dragOffsetX=x-mask.x; dragOffsetY=y-mask.y;
  } else if(shapeSelect.value==='circle'){
    const cx=mask.x+mask.w/2, cy=mask.y+mask.h/2;
    const r=Math.min(mask.w,mask.h)/2;
    if(Math.hypot(x-cx,y-cy)<=r){dragging=true; dragOffsetX=x-mask.x; dragOffsetY=y-mask.y;}
  }
});
canvas.addEventListener('mousemove', e=>{
  if(!dragging) return;
  const rect=canvas.getBoundingClientRect();
  mask.x=e.clientX-rect.left-dragOffsetX;
  mask.y=e.clientY-rect.top-dragOffsetY;
  draw();
});
canvas.addEventListener('mouseup', ()=>dragging=false);
canvas.addEventListener('mouseleave', ()=>dragging=false);

// Touch support
canvas.addEventListener('touchstart', e=>{
  const touch=e.touches[0];
  const rect=canvas.getBoundingClientRect();
  const x=touch.clientX-rect.left;
  const y=touch.clientY-rect.top;
  if(shapeSelect.value==='rect' && x>mask.x && x<mask.x+mask.w && y>mask.y && y<mask.y+mask.h){
    dragging=true; dragOffsetX=x-mask.x; dragOffsetY=y-mask.y;
  } else if(shapeSelect.value==='circle'){
    const cx=mask.x+mask.w/2, cy=mask.y+mask.h/2;
    const r=Math.min(mask.w,mask.h)/2;
    if(Math.hypot(x-cx,y-cy)<=r){dragging=true; dragOffsetX=x-mask.x; dragOffsetY=y-mask.y;}
  }
});
canvas.addEventListener('touchmove', e=>{
  if(!dragging) return;
  const touch=e.touches[0];
  const rect=canvas.getBoundingClientRect();
  mask.x=touch.clientX-rect.left-dragOffsetX;
  mask.y=touch.clientY-rect.top-dragOffsetY;
  draw();
});
canvas.addEventListener('touchend', ()=>dragging=false);

// Boutons agrandir / réduire
increaseBtn.addEventListener('click', ()=>{
  mask.w +=20; mask.h +=20; draw();
});
decreaseBtn.addEventListener('click', ()=>{
  mask.w = Math.max(20,mask.w-20);
  mask.h = Math.max(20,mask.h-20);
  draw();
});

// Reset
resetBtn.addEventListener('click', ()=>{
  mask={x:200,y:150,w:400,h:300}; draw();
});

// Export image
exportBtn.addEventListener('click', ()=>{
  const link=document.createElement('a');
  link.download='image_flou.png';
  link.href=canvas.toDataURL('image/png');
  link.click();
});

blurRange.addEventListener('input', draw);
shapeSelect.addEventListener('change', draw);
img.onload=draw;
</script>
</body>
</html>