<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR App — Générateur & Scanner</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa4b2;--glass:rgba(255,255,255,0.03)}
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{margin:0;background:linear-gradient(180deg,#071022 0%, #07162a 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
  .wrap{width:100%;max-width:1000px;display:grid;grid-template-columns:1fr 420px;gap:20px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  h1{margin:0 0 10px;font-size:20px}
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input[type="text"], select, textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
  textarea{min-height:110px;resize:vertical}
  .row{display:flex;gap:8px;margin-top:12px}
  button{background:var(--accent);border:none;padding:10px 12px;border-radius:10px;color:#042;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:500}
  .preview{display:flex;flex-direction:column;align-items:center;gap:12px}
  #qrcode{background:white;padding:12px;border-radius:8px}
  .muted{color:var(--muted);font-size:13px}
  .scanner{width:100%;height:320px;background:#050817;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
  video{width:100%;height:100%;object-fit:cover}
  canvas{display:none}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .small{padding:8px 10px;font-size:14px}
  .flex-col{display:flex;flex-direction:column}
  .footer{font-size:13px;color:var(--muted);margin-top:10px;text-align:center}
  @media(max-width:980px){.wrap{grid-template-columns:1fr;}.scanner{height:260px}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: generator -->
    <div class="card">
      <h1>Générateur de QR</h1>
      <div class="muted">Tape un texte ou une URL — tu peux aussi choisir des formats spéciaux (Wi-Fi / vCard).</div>

      <label>Type</label>
      <select id="type">
        <option value="text">Texte simple</option>
        <option value="url">URL</option>
        <option value="wifi">Wi-Fi (WEP/WPA)</option>
        <option value="vcard">vCard (contact)</option>
      </select>

      <div id="fields" class="flex-col">
        <!-- dynamic fields will be injected -->
      </div>

      <div class="row">
        <button id="generate">Générer le QR</button>
        <button id="download" class="ghost">Télécharger PNG</button>
        <button id="clear" class="ghost small">Effacer</button>
      </div>

      <div style="margin-top:18px" class="preview">
        <div id="qrcode"></div>
        <div class="muted">Aperçu — clique droit → enregistrer l'image ou utilise Télécharger PNG.</div>
      </div>

      <div class="footer">Fonctionne sans compte. Scanner en bas.</div>
    </div>

    <!-- RIGHT: scanner -->
    <div class="card">
      <h1>Scanner QR</h1>
      <div class="muted">Utilise la caméra (si autorisé) ou téléverse une image contenant un QR.</div>

      <div class="scanner" id="scanner">
        <div id="videoWrap" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative">
          <div id="videoMessage" class="muted">Appuie sur <b>Activer la caméra</b> pour scanner en direct</div>
          <video id="video" autoplay playsinline></video>
        </div>
      </div>

      <div class="controls">
        <button id="startCam">Activer la caméra</button>
        <button id="stopCam" class="ghost">Stop caméra</button>
        <input type="file" id="fileInput" accept="image/*" />
      </div>

      <div style="margin-top:12px">
        <label>Résultat décodé</label>
        <textarea id="result" readonly></textarea>
      </div>

      <canvas id="canvas"></canvas>

      <div class="footer" id="bd">Si ton navigateur supporte <code>BarcodeDetector</code>, il servira de moteur. Sinon on utilisera un décodeur JS.</div>
    </div>
  </div>

  <!-- Librairies -->
  <!-- Générateur: qrcodejs (génère un canvas/svg dans #qrcode) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Fallback pour le scan si BarcodeDetector absent -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>

  <script>
  // --- éléments DOM ---
  const typeSel = document.getElementById('type');
  const fields = document.getElementById('fields');
  const qrcodeDiv = document.getElementById('qrcode');
  const generateBtn = document.getElementById('generate');
  const downloadBtn = document.getElementById('download');
  const clearBtn = document.getElementById('clear');

  // scanner elements
  const startCamBtn = document.getElementById('startCam');
  const stopCamBtn = document.getElementById('stopCam');
  const fileInput = document.getElementById('fileInput');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const resultBox = document.getElementById('result');
  const videoMessage = document.getElementById('videoMessage');

  let qr; // QRCode instance
  let stream = null;
  let scanInterval = null;
  let barcodeDetector = null;

  // --- champs dynamiques selon type ---
  function renderFields() {
    const t = typeSel.value;
    fields.innerHTML = '';
    if (t === 'text' || t === 'url') {
      const area = document.createElement('textarea');
      area.id = 'mainInput';
      area.placeholder = t === 'url' ? 'https://example.com' : 'Écris ton texte ici...';
      fields.appendChild(area);
    } else if (t === 'wifi') {
      fields.innerHTML = `
        <label>SSID</label><input id="ssid" type="text" placeholder="Nom du réseau" />
        <label>Type de sécurité</label>
        <select id="secure"><option value="WPA">WPA/WPA2</option><option value="WEP">WEP</option><option value="nopass">Aucun</option></select>
        <label>Mot de passe</label><input id="pwd" type="text" placeholder="Mot de passe" />
      `;
    } else if (t === 'vcard') {
      fields.innerHTML = `
        <label>Nom complet</label><input id="fullname" type="text" placeholder="Prénom Nom" />
        <label>Téléphone</label><input id="phone" type="text" placeholder="+33..." />
        <label>Email</label><input id="email" type="text" placeholder="exemple@mail.com" />
        <label>Entreprise / Job (optionnel)</label><input id="org" type="text" placeholder="Entreprise" />
      `;
    }
  }
  typeSel.addEventListener('change', renderFields);
  renderFields();

  // --- generate QR ---
  function buildPayload() {
    const t = typeSel.value;
    if (t === 'text' || t === 'url') {
      return document.getElementById('mainInput').value || '';
    } else if (t === 'wifi') {
      const ssid = document.getElementById('ssid').value || '';
      const secure = document.getElementById('secure').value;
      const pwd = document.getElementById('pwd').value || '';
      // Format WiFi: WIFI:T:WPA;S:mynetwork;P:mypass;;
      return `WIFI:T:${secure};S:${escapeSemi(ssid)};P:${escapeSemi(pwd)};;`;
    } else if (t === 'vcard') {
      const name = document.getElementById('fullname').value || '';
      const tel = document.getElementById('phone').value || '';
      const mail = document.getElementById('email').value || '';
      const org = document.getElementById('org').value || '';
      let v = "BEGIN:VCARD\\nVERSION:3.0\\n";
      if (name) v += `FN:${name}\\n`;
      if (org) v += `ORG:${org}\\n`;
      if (tel) v += `TEL:${tel}\\n`;
      if (mail) v += `EMAIL:${mail}\\n`;
      v += "END:VCARD";
      return v;
    }
    return '';
  }
  function escapeSemi(s){ return s.replace(/;/g,'\\;'); }

  function generateQR() {
    const data = buildPayload();
    if (!data) {
      alert("Renseigne d'abord le texte / champs.");
      return;
    }
    // clear previous
    qrcodeDiv.innerHTML = '';

    // create QRCode (qrcodejs)
    qr = new QRCode(qrcodeDiv, {
      text: data,
      width: 280,
      height: 280,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });
  }

  generateBtn.addEventListener('click', generateQR);

  clearBtn.addEventListener('click', () => {
    qrcodeDiv.innerHTML = '';
    document.querySelectorAll('#fields input, #fields textarea, #fields select').forEach(i=>i.value='');
  });

  // download PNG
  downloadBtn.addEventListener('click', () => {
    // find canvas inside qrcodeDiv or the img
    const canvasEl = qrcodeDiv.querySelector('canvas');
    if (canvasEl) {
      const url = canvasEl.toDataURL('image/png');
      triggerDownload(url, 'qr-code.png');
      return;
    }
    // qrcodejs also sometimes outputs an <img>
    const img = qrcodeDiv.querySelector('img');
    if (img) {
      triggerDownload(img.src, 'qr-code.png');
      return;
    }
    alert('Génère d\'abord un QR.');
  });

  function triggerDownload(dataUrl, filename){
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // --- Scanner logic ---
  async function initBarcodeDetector() {
    if ('BarcodeDetector' in window) {
      const formats = await BarcodeDetector.getSupportedFormats();
      try {
        barcodeDetector = new BarcodeDetector({formats});
        document.getElementById('bd').textContent = 'BarcodeDetector détecté — scan natif activé.';
      } catch(e){
        barcodeDetector = null;
      }
    } else {
      document.getElementById('bd').textContent = 'BarcodeDetector non disponible — utilisation de jsQR (fallback).';
    }
  }
  initBarcodeDetector();

  startCamBtn.addEventListener('click', async () => {
    if (stream) return;
    try {
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject = stream;
      videoMessage.style.display = 'none';
      // start scanning frames
      scanInterval = requestAnimationFrame(tick);
    } catch (err) {
      alert('Impossible d\'ouvrir la caméra : ' + err.message);
    }
  });

  stopCamBtn.addEventListener('click', () => {
    stopStream();
  });

  function stopStream(){
    if (stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
      video.srcObject = null;
      videoMessage.style.display = 'block';
      if (scanInterval) cancelAnimationFrame(scanInterval);
      scanInterval = null;
    }
  }

  // decode using BarcodeDetector or jsQR
  async function tick(){
    if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) {
      scanInterval = requestAnimationFrame(tick);
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    try {
      if (barcodeDetector) {
        const barcodes = await barcodeDetector.detect(canvas);
        if (barcodes && barcodes.length) {
          // we take the first
          const bc = barcodes[0];
          resultBox.value = bc.rawValue || JSON.stringify(bc);
          // optional: stop streaming once we got a result
          // stopStream();
        } else {
          // clear only if empty
          // resultBox.value = '';
        }
      } else if (window.jsQR) {
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          resultBox.value = code.data;
        }
      }
    } catch (e) {
      console.error(e);
    }

    scanInterval = requestAnimationFrame(tick);
  }

  // file upload decode (fallback)
  fileInput.addEventListener('change', (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    const img = new Image();
    const url = URL.createObjectURL(f);
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0);
      // try BarcodeDetector on the canvas, else jsQR
      (async ()=>{
        if (barcodeDetector) {
          try {
            const barcodes = await barcodeDetector.detect(canvas);
            if (barcodes && barcodes.length) {
              resultBox.value = barcodes[0].rawValue || JSON.stringify(barcodes[0]);
              URL.revokeObjectURL(url);
              return;
            }
          } catch(e){}
        }
        if (window.jsQR) {
          const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            resultBox.value = code.data;
            URL.revokeObjectURL(url);
            return;
          }
        }
        alert('Aucun QR détecté dans l\'image.');
        URL.revokeObjectURL(url);
      })();
    };
    img.onerror = () => { alert('Impossible de charger l\'image.'); URL.revokeObjectURL(url); };
    img.src = url;
  });

  // --- init ---
  // small helpful defaults
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('mainInput')?.focus?.();
  });

  // Clean up when leaving page
  window.addEventListener('pagehide', stopStream);
  window.addEventListener('beforeunload', stopStream);
  </script>
</body>
</html>