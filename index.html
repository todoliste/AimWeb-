<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CapCut-style Editor ‚Äî Vanilla HTML/JS</title>

<!-- Google fonts (10 fonts example) -->
<link href="https://fonts.googleapis.com/css2?family=Roboto&family=Montserrat&family=Lora&family=Poppins&family=Oswald&family=Merriweather&family=Raleway&family=Playfair+Display&family=Nunito&family=Fira+Sans&display=swap" rel="stylesheet">

<style>
  /* ========== THEME / LAYOUT ========== */
  :root{
    --bg:#0b0b0d;
    --panel:#0f1724;
    --muted:#9ca3af;
    --accent:#7c3aed;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family: Poppins, Roboto, system-ui, -apple-system, "Segoe UI", Arial; background:var(--bg); color:#fff}
  .app{display:flex;flex-direction:column;gap:12px;padding:12px;height:100%}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:linear-gradient(90deg,#0f1724,#0b0b0d)}
  .logo{display:flex;gap:10px;align-items:center}
  .logo .badge{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:700}
  .actions button{margin-left:8px;padding:8px 12px;border-radius:8px;border:0;background:#111827;color:#fff;cursor:pointer}
  .actions .primary{background:linear-gradient(90deg,#4f46e5,#7c3aed)}
  main{display:flex;gap:12px;flex:1;min-height:0} /* min-height:0 so flex children can scroll */
  aside.left, aside.right{width:260px;background:var(--panel);padding:12px;border-radius:12px;overflow:auto}
  .center{flex:1;display:flex;flex-direction:column;gap:12px}
  .preview{background:#08101a;padding:12px;border-radius:10px}
  .canvas-wrap{position:relative;min-height:320px;border-radius:8px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
  canvas#preview{max-width:100%;height:auto;display:block;box-shadow:0 8px 40px rgba(0,0,0,0.6)}
  .controls{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,0.45);padding:8px;border-radius:8px;display:flex;gap:6px;align-items:center}
  .timeline { background:#071021;padding:10px;border-radius:10px }
  .timeline-track{overflow-x:auto;padding:8px;border-radius:8px;background:#06111a}
  .track-canvas{position:relative;height:120px;min-width:800px}
  .grid-line{position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.03)}
  .item{position:absolute;height:28px;border-radius:6px;display:flex;align-items:center;padding:4px;gap:8px;cursor:pointer;user-select:none}
  .item .name{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .props{display:flex;flex-direction:column;gap:8px}
  .media-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .media-card{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#0b1220;cursor:grab}
  .media-card .thumb{width:56px;height:40px;border-radius:6px;background:#374151;display:flex;align-items:center;justify-content:center;font-size:12px}
  footer{display:flex;justify-content:space-between;opacity:0.8}
  input[type=range]{width:120px}
  select,button,input[type=text]{background:#0b1220;border:1px solid rgba(255,255,255,0.04);color:#fff;padding:6px;border-radius:6px}
  .small{font-size:13px;color:var(--muted)}
  .template-row{display:flex;gap:8px;margin-top:8px}
  .template-row button{padding:6px 8px;background:#111827;border-radius:8px}
  /* scrollbars */
  ::-webkit-scrollbar{height:10px;width:10px}
  ::-webkit-scrollbar-thumb{background:#1f2937;border-radius:8px}
  /* responsive */
  @media (max-width:1000px){ aside.left, aside.right{width:100%} main{flex-direction:column} .track-canvas{min-width:100%} }
</style>
</head>
<body>
<div class="app">

  <!-- Top bar -->
  <header>
    <div class="logo">
      <div class="badge">CP</div>
      <div>
        <div style="font-weight:700">CapCut-Style Editor</div>
        <div class="small" id="projectName">Mon projet</div>
      </div>
    </div>

    <div class="actions">
      <button id="newProjectBtn">Nouveau projet</button>
      <button id="exportBtn" class="primary">Exporter</button>
    </div>
  </header>

  <main>
    <!-- LEFT: Library -->
    <aside class="left">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Biblioth√®que</strong>
        <div class="small" id="libCount">0 √©l√©ments</div>
      </div>

      <!-- upload controls -->
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="mediaInput" type="file" accept="image/*,video/*" multiple style="display:none" />
        <button onclick="document.getElementById('mediaInput').click()">Uploader m√©dias</button>

        <input id="audioInput" type="file" accept="audio/*" style="display:none" />
        <button onclick="document.getElementById('audioInput').click()">Ajouter musique</button>
      </div>

      <!-- templates -->
      <div class="small" style="margin-top:10px">Templates</div>
      <div class="template-row" id="templatesRow">
        <button data-template="birthday">Anniversaire</button>
        <button data-template="travel">Voyage</button>
        <button data-template="love">Love story</button>
      </div>

      <!-- media list -->
      <div class="media-list" id="mediaList" style="margin-top:12px"></div>
    </aside>

    <!-- CENTER: Preview + Timeline -->
    <section class="center">
      <div class="preview">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>Pr√©visualisation</div>
          <div class="small" id="timeLabel">0.00s / 10s</div>
        </div>

        <!-- Canvas preview -->
        <div class="canvas-wrap">
          <canvas id="preview" width="1280" height="720"></canvas>

          <!-- controls -->
          <div class="controls">
            <button id="playBtn">Play</button>
            <button id="back1">-1s</button>
            <button id="fwd1">+1s</button>
            <label class="small" style="margin-left:8px">Zoom TL</label>
            <input id="timelineZoom" type="range" min="0.5" max="2" step="0.1" value="1">
          </div>
        </div>
      </div>

      <!-- timeline -->
      <div class="timeline">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>Timeline</div>
          <div class="small">Astuce: glisse les √©l√©ments depuis la biblioth√®que vers la timeline</div>
        </div>
        <div class="timeline-track" id="timelineTrack">
          <div class="track-canvas" id="trackCanvas"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Properties -->
    <aside class="right">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Propri√©t√©s</strong>
        <div class="small" id="selLabel">Aucun</div>
      </div>

      <div class="props" id="propsArea">
        <div class="small">S√©lectionne un √©l√©ment dans la timeline pour √©diter</div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.04);margin:8px 0">

      <div class="small">Audio</div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
        <div class="small" id="audioName">Aucune</div>
        <div style="flex:1"></div>
        <label class="small">Vol</label>
        <input id="audioVol" type="range" min="0" max="1" step="0.01" value="1">
      </div>
    </aside>
  </main>

  <footer>
    <div class="small">Raccourcis: Espace=play/pause ‚Ä¢ Suppr=effacer ‚Ä¢ Ctrl+Z / Ctrl+Y undo/redo</div>
    <div class="small">Export: canvas + audio (webm). Pour MP4 ‚Äî convertir localement avec ffmpeg.</div>
  </footer>
</div>

<script>
/* ==========================
   CapCut-style editor (Vanilla JS)
   - Single-file prototype
   - Comments throughout
   ========================== */

/* ---------- State ---------- */
const state = {
  projectName: 'Mon projet',
  media: [], // {id,file,type,url,duration,element,width,height}
  timeline: [], // {id,refId,type,start,duration,transition,filter,text,z}
  selected: null,
  playhead: 0,
  playing: false,
  zoom: 1,
  fps: 30,
  resolution: {w:1280,h:720},
  audio: null, // {file,url,element}
  undoStack: [],
  redoStack: [],
  duration: 10 // total project duration (s) - will expand based on items
};

/* ---------- Helpers ---------- */
const $ = (s) => document.querySelector(s);
const nowId = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;

function pushUndo() {
  const snap = {
    media: state.media.map(m=>({id:m.id,type:m.type,url:m.url,duration:m.duration,name:m.file?.name})),
    timeline: JSON.parse(JSON.stringify(state.timeline)),
    audio: state.audio?{url:state.audio.url}:null,
    projectName: state.projectName
  };
  state.undoStack.push(snap);
  if(state.undoStack.length > 50) state.undoStack.shift();
  state.redoStack = []; // clear redo
}

function undo() {
  if(state.undoStack.length===0) return;
  const last = state.undoStack.pop();
  state.redoStack.push({
    media: state.media.map(m=>({id:m.id,type:m.type,url:m.url,duration:m.duration,name:m.file?.name})),
    timeline: JSON.parse(JSON.stringify(state.timeline)),
    audio: state.audio?{url:state.audio.url}:null,
    projectName: state.projectName
  });
  state.media = (last.media||[]).map(m=>({...m, element: new Image()}));
  state.timeline = last.timeline||[];
  state.audio = last.audio ? {url:last.audio.url, element: new Audio(last.audio.url)} : null;
  renderAll();
}

function redo() {
  if(state.redoStack.length===0) return;
  const last = state.redoStack.pop();
  state.undoStack.push({
    media: state.media.map(m=>({id:m.id,type:m.type,url:m.url,duration:m.duration,name:m.file?.name})),
    timeline: JSON.parse(JSON.stringify(state.timeline)),
    audio: state.audio?{url:state.audio.url}:null,
    projectName: state.projectName
  });
  state.media = (last.media||[]).map(m=>({...m, element: new Image()}));
  state.timeline = last.timeline||[];
  state.audio = last.audio ? {url:last.audio.url, element: new Audio(last.audio.url)} : null;
  renderAll();
}

/* ---------- DOM refs ---------- */
const canvas = $('#preview');
const ctx = canvas.getContext('2d');
const mediaInput = $('#mediaInput');
const mediaListEl = $('#mediaList');
const libCountEl = $('#libCount');
const trackCanvas = $('#trackCanvas');
const playBtn = $('#playBtn');
const timeLabel = $('#timeLabel');
const timelineZoom = $('#timelineZoom');
const exportBtn = $('#exportBtn');
const propsArea = $('#propsArea');
const selLabel = $('#selLabel');
const audioInput = $('#audioInput');
const audioName = $('#audioName');
const audioVol = $('#audioVol');
const projectNameEl = $('#projectName');
const templatesRow = $('#templatesRow');
const newProjectBtn = $('#newProjectBtn');

/* ---------- Rendering helpers ---------- */

function recalcDuration() {
  // project duration equals max end time of timeline items or minimum 10s
  const mx = state.timeline.reduce((m,it)=>Math.max(m, it.start + it.duration), 0);
  state.duration = Math.max(10, Math.ceil(mx));
}

function renderLibrary() {
  mediaListEl.innerHTML = '';
  state.media.forEach(m=>{
    const div = document.createElement('div');
    div.className = 'media-card';
    div.draggable = true;
    div.dataset.id = m.id;
    div.innerHTML = `<div class="thumb">${m.type}</div>
                     <div style="flex:1"><div class="name">${m.file?.name || m.url}</div><div class="small">${m.duration}s</div></div>
                     <div><button data-add="${m.id}">+</button></div>`;
    mediaListEl.appendChild(div);

    // on click add to timeline
    div.querySelector('[data-add]')?.addEventListener('click', (e)=>{
      e.stopPropagation();
      addToTimeline(m.id);
    });

    // dragstart from library -> timeline
    div.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/media', m.id);
    });
  });
  libCountEl.textContent = `${state.media.length} √©l√©ments`;
}

function renderTimeline() {
  recalcDuration();
  const totalWidth = Math.max(800, state.duration * 100 * state.zoom);
  trackCanvas.style.minWidth = totalWidth + 'px';
  trackCanvas.innerHTML = '';

  // grid lines
  for(let i=0;i<=state.duration;i++){
    const l = document.createElement('div');
    l.className = 'grid-line';
    l.style.left = (i * 100 * state.zoom) + 'px';
    trackCanvas.appendChild(l);
  }

  // items
  state.timeline.forEach((it,index)=>{
    const el = document.createElement('div');
    el.className = 'item';
    el.style.left = (it.start * 100 * state.zoom) + 'px';
    el.style.top = (10 + (it.z || 0) * 34) + 'px';
    el.style.width = (it.duration * 100 * state.zoom) + 'px';
    el.style.background = (state.selected===it.id) ? '#3b82f6' : '#1f2937';
    el.dataset.id = it.id;
    el.innerHTML = `<div style="flex:1" class="name">${(state.media.find(m=>m.id===it.refId)?.file?.name)||it.refId}</div>
                    <div style="font-size:12px;margin-left:6px">${it.duration}s</div>
                    <div style="margin-left:6px"><button class="del">X</button></div>`;

    // select
    el.addEventListener('click', (e)=> {
      e.stopPropagation();
      state.selected = it.id;
      renderProps();
      renderTimeline();
    });

    // delete button
    el.querySelector('.del').addEventListener('click', (e)=>{
      e.stopPropagation();
      if(!confirm('Supprimer cet √©l√©ment ?')) return;
      pushUndo();
      state.timeline = state.timeline.filter(x=>x.id!==it.id);
      if(state.selected===it.id) state.selected = null;
      renderAll();
    });

    // drag reorder within timeline
    el.draggable = true;
    el.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/timeline', it.id);
    });

    trackCanvas.appendChild(el);
  });

  // playhead marker
  const ph = document.createElement('div');
  ph.style.position='absolute';
  ph.style.left = (state.playhead * 100 * state.zoom - 1) + 'px';
  ph.style.top = '0';
  ph.style.bottom = '0';
  ph.style.width = '2px';
  ph.style.background = '#ef4444';
  trackCanvas.appendChild(ph);
}

function renderProps() {
  if(!state.selected) {
    selLabel.textContent = 'Aucun';
    propsArea.innerHTML = `<div class="small">S√©lectionne un √©l√©ment dans la timeline pour √©diter</div>`;
    return;
  }
  const it = state.timeline.find(t=>t.id===state.selected);
  if(!it) { state.selected = null; renderProps(); return; }
  selLabel.textContent = '√âl√©ment s√©lectionn√©';
  const media = state.media.find(m=>m.id===it.refId);
  propsArea.innerHTML = '';
  const wrap = document.createElement('div');

  wrap.innerHTML = `
    <div class="small">Source: ${media?.file?.name || it.refId}</div>
    <div>Dur√©e: <input id="propDur" type="range" min="1" max="30" value="${it.duration}"> <span class="small" id="durLabel">${it.duration}s</span></div>
    <div>Transition:
      <select id="propTrans">
        <option value="none">None</option>
        <option value="fade"${it.transition==='fade'?' selected':''}>Fondu</option>
        <option value="slide"${it.transition==='slide'?' selected':''}>Glissement</option>
        <option value="zoom"${it.transition==='zoom'?' selected':''}>Zoom</option>
      </select>
    </div>
    <div>Filtre:
      <select id="propFilter">
        <option value="none"${it.filter==='none'?' selected':''}>Aucun</option>
        <option value="bw"${it.filter==='bw'?' selected':''}>Noir & Blanc</option>
        <option value="sepia"${it.filter==='sepia'?' selected':''}>S√©pia</option>
        <option value="vivid"${it.filter==='vivid'?' selected':''}>Vif</option>
        <option value="cinema"${it.filter==='cinema'?' selected':''}>Cin√©matique</option>
      </select>
    </div>
    <div>Texte: <input id="propText" type="text" placeholder="Ajouter un texte" value="${it.text?it.text.content:''}"></div>
    <div>Police: <select id="propFont">
      <option>Poppins</option><option>Roboto</option><option>Montserrat</option><option>Lora</option><option>Oswald</option>
      <option>Merriweather</option><option>Raleway</option><option>Playfair Display</option><option>Nunito</option><option>Fira Sans</option>
    </select></div>
    <div>Position X: <input id="propTX" type="range" min="0" max="${state.resolution.w}" value="${(it.text?.x)||50}"></div>
    <div>Position Y: <input id="propTY" type="range" min="0" max="${state.resolution.h}" value="${(it.text?.y)||70}"></div>
  `;
  propsArea.appendChild(wrap);

  // wire controls
  $('#propDur').addEventListener('input', (e)=>{
    pushUndo();
    it.duration = parseInt(e.target.value);
    $('#durLabel').textContent = it.duration+'s';
    renderAll();
  });
  $('#propTrans').addEventListener('change', (e)=>{ pushUndo(); it.transition = e.target.value; renderAll(); });
  $('#propFilter').addEventListener('change', (e)=>{ pushUndo(); it.filter = e.target.value; renderAll(); });
  $('#propText').addEventListener('change', (e)=>{ pushUndo(); it.text = it.text || {content:''}; it.text.content = e.target.value; renderAll(); });
  $('#propFont').value = it.text?.font || 'Poppins';
  $('#propFont').addEventListener('change', (e)=>{ pushUndo(); it.text = it.text || {}; it.text.font = e.target.value; renderAll(); });
  $('#propTX').addEventListener('input', (e)=>{ pushUndo(); it.text = it.text || {}; it.text.x = parseInt(e.target.value); renderAll(); });
  $('#propTY').addEventListener('input', (e)=>{ pushUndo(); it.text = it.text || {}; it.text.y = parseInt(e.target.value); renderAll(); });
}

/* ---------- Draw / Playback ---------- */

function clearCanvas() {
  ctx.fillStyle = '#111';
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function applyFilter(ctx, filterName) {
  // returns CSS filter string to apply to ctx.filter
  switch(filterName){
    case 'bw': return 'grayscale(100%)';
    case 'sepia': return 'sepia(60%)';
    case 'vivid': return 'saturate(1.4) contrast(1.05) brightness(1.02)';
    case 'cinema': return 'contrast(1.15) saturate(0.9) sepia(6%)';
    default: return 'none';
  }
}

function drawFrame(t) {
  clearCanvas();
  // background
  ctx.fillStyle = '#111';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // find items visible at time t, ordered by z
  const items = state.timeline.filter(it => t >= it.start && t <= it.start + it.duration).sort((a,b)=> (a.z||0)-(b.z||0));
  // if multiple, draw them in order; simple transition: if an item has transition fade and is within first/last 0.5s, apply alpha
  items.forEach(it=>{
    const m = state.media.find(mm=>mm.id===it.refId);
    if(!m) return;
    const el = m.element;
    // compute fit
    const elw = el.videoWidth || el.naturalWidth || canvas.width;
    const elh = el.videoHeight || el.naturalHeight || canvas.height;
    const ratio = Math.min(canvas.width/elw, canvas.height/elh);
    const w = elw*ratio, h = elh*ratio;
    const x = (canvas.width - w)/2, y = (canvas.height - h)/2;

    ctx.save();

    // apply filter via ctx.filter
    const filterStr = applyFilter(ctx, it.filter);
    ctx.filter = filterStr;

    // transition handling: simple fade or slide
    let alpha = 1;
    const localT = t - it.start;
    const fadeDur = Math.min(0.5, it.duration/3);
    if(it.transition === 'fade') {
      if(localT < fadeDur) alpha = localT / fadeDur;
      if(localT > it.duration - fadeDur) alpha = (it.duration - localT) / fadeDur;
    } else if(it.transition === 'slide') {
      // slide from left on enter
      let slideX = 0;
      if(localT < fadeDur) slideX = - (1 - (localT/fadeDur)) * canvas.width * 0.3;
      ctx.translate(slideX,0);
    } else if(it.transition === 'zoom') {
      let zoom = 1;
      if(localT < fadeDur) zoom = 1 + (1 - (localT/fadeDur))*0.1;
      if(localT > it.duration - fadeDur) zoom = 1 + (1 - ((it.duration - localT)/fadeDur))*0.1;
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.scale(zoom,zoom);
      ctx.translate(-canvas.width/2, -canvas.height/2);
    }

    ctx.globalAlpha = alpha;

    try {
      if(it.type === 'video') {
        // Ensure video is updated to correct time (for preview smoothness we might set currentTime but avoid heavy seeking)
        if(el.readyState >= 2) ctx.drawImage(el, x, y, w, h);
      } else {
        if(el.complete) ctx.drawImage(el, x, y, w, h);
      }
    } catch(e){ /* ignore if not ready */ }

    // draw text overlay if present
    if(it.text && it.text.content) {
      ctx.filter = 'none'; // text unaffected by image filter
      ctx.globalAlpha = 1;
      ctx.font = `${it.text.size || 48}px ${it.text.font || 'Poppins'}`;
      ctx.fillStyle = it.text.color || 'white';
      ctx.shadowColor = 'rgba(0,0,0,0.6)';
      ctx.shadowBlur = 8;
      const tx = it.text.x || 50, ty = it.text.y || 70;
      ctx.fillText(it.text.content, tx, ty);
    }

    ctx.restore();
  });

  // timeline overlay (small black bar)
  ctx.fillStyle = 'rgba(255,255,255,0.03)';
  ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
  // playhead indicator (thin)
  const px = (state.playhead/state.duration) * canvas.width;
  ctx.fillStyle = '#fff';
  ctx.fillRect(px, canvas.height - 60, 2, 60);
}

/* ---------- Playback loop ---------- */
let rafId = null;
let startPerf = 0;

function play() {
  if(state.playing) return;
  state.playing = true;
  startPerf = performance.now() - state.playhead * 1000;
  // start audio if exists
  if(state.audio && state.audio.element){
    try {
      state.audio.element.currentTime = state.playhead;
      state.audio.element.play();
    } catch(e) {}
  }
  rafId = requestAnimationFrame(tick);
  playBtn.textContent = 'Pause';
}

function pause() {
  if(!state.playing) return;
  state.playing = false;
  if(rafId) cancelAnimationFrame(rafId);
  if(state.audio && state.audio.element) state.audio.element.pause();
  playBtn.textContent = 'Play';
}

function tick(ts) {
  const t = (ts - startPerf)/1000;
  state.playhead = t;
  if(t >= state.duration) {
    state.playhead = state.duration;
    pause();
    renderAll();
    return;
  }
  drawFrame(t);
  timeLabel.textContent = `${state.playhead.toFixed(2)}s / ${state.duration}s`;
  renderTimeline(); // move playhead marker
  rafId = requestAnimationFrame(tick);
}

/* ---------- Media loading ---------- */

mediaInput.addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files || []);
  if(files.length===0) return;
  pushUndo();
  for(const f of files){
    const url = URL.createObjectURL(f);
    const type = f.type.startsWith('video') ? 'video' : 'image';
    const id = nowId('m');
    let duration = 5;
    let element;
    if(type === 'video'){
      element = document.createElement('video');
      element.src = url; element.muted = true; element.preload = 'metadata';
      await new Promise(res => element.addEventListener('loadedmetadata', res, {once:true}));
      duration = Math.min(30, Math.max(1, Math.round(element.duration) || 5));
    } else {
      element = new Image();
      await new Promise(res => { element.onload = res; element.src = url; });
      duration = 5;
    }
    state.media.push({id, file:f, type, url, duration, element});
  }
  e.target.value = '';
  renderAll();
});

function addToTimeline(mediaId) {
  pushUndo();
  const m = state.media.find(x=>x.id===mediaId);
  if(!m) return;
  // start at end of last
  const lastEnd = state.timeline.reduce((mx,it)=>Math.max(mx, it.start + it.duration), 0);
  const item = {
    id: nowId('t'),
    refId: mediaId,
    type: m.type,
    start: lastEnd,
    duration: m.type==='video' ? m.duration : 5,
    transition: 'none',
    filter: 'none',
    text: null,
    z: state.timeline.length
  };
  state.timeline.push(item);
  renderAll();
}

/* ---------- Drag & Drop timeline area ---------- */
// Accept drops into trackCanvas
trackCanvas.addEventListener('dragover', (e)=>{ e.preventDefault(); trackCanvas.classList.add('drag'); });
trackCanvas.addEventListener('dragleave', ()=> trackCanvas.classList.remove('drag'));
trackCanvas.addEventListener('drop', (e)=>{
  e.preventDefault();
  trackCanvas.classList.remove('drag');
  const mediaId = e.dataTransfer.getData('text/media');
  const tlId = e.dataTransfer.getData('text/timeline');
  const rect = trackCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const time = x / (100 * state.zoom);
  if(mediaId){
    pushUndo();
    const m = state.media.find(m=>m.id===mediaId);
    if(!m) return;
    const item = {
      id: nowId('t'),
      refId: mediaId,
      type: m.type,
      start: Math.max(0, Math.round(time*100)/100),
      duration: m.type==='video' ? m.duration : 5,
      transition:'none',filter:'none',text:null,z:state.timeline.length
    };
    state.timeline.push(item);
    renderAll();
  } else if(tlId){
    // move existing timeline item to new start
    pushUndo();
    const it = state.timeline.find(it=>it.id===tlId);
    if(it) { it.start = Math.max(0, Math.round(time*100)/100); renderAll(); }
  }
});

/* Also allow dragging timeline items between tracks to reorder z */
trackCanvas.addEventListener('drop', ()=>{}); // handled above

/* ---------- Click handlers ---------- */
playBtn.addEventListener('click', ()=> state.playing ? pause() : play());
$('#back1').addEventListener('click', ()=> { state.playhead = Math.max(0, state.playhead - 1); drawFrame(state.playhead); renderTimeline(); timeLabel.textContent = `${state.playhead.toFixed(2)}s / ${state.duration}s`; });
$('#fwd1').addEventListener('click', ()=> { state.playhead = Math.min(state.duration, state.playhead + 1); drawFrame(state.playhead); renderTimeline(); timeLabel.textContent = `${state.playhead.toFixed(2)}s / ${state.duration}s`; });
timelineZoom.addEventListener('input', (e)=> { state.zoom = parseFloat(e.target.value); renderTimeline(); });

/* ---------- Audio ---------- */
audioInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  pushUndo();
  const url = URL.createObjectURL(f);
  const audioEl = new Audio(url);
  audioEl.crossOrigin='anonymous';
  await new Promise(res=> audioEl.addEventListener('loadedmetadata', res, {once:true}));
  state.audio = {file:f, url, element: audioEl};
  audioName.textContent = f.name;
  audioVol.value = 1;
  audioVol.dispatchEvent(new Event('input'));
  e.target.value = '';
});
audioVol.addEventListener('input',(e)=>{
  const v = parseFloat(e.target.value);
  if(state.audio && state.audio.element) state.audio.element.volume = v;
});

/* ---------- Export (MediaRecorder + canvas.captureStream) ---------- */
exportBtn.addEventListener('click', async ()=>{
  // show resolution choices
  const format = prompt('Choix export: "720p", "1080p", "1:1", "9:16" (par d√©faut 1080p)', '1080p') || '1080p';
  const map = {'720p':{w:1280,h:720}, '1080p':{w:1920,h:1080}, '1:1':{w:1080,h:1080}, '9:16':{w:720,h:1280}};
  const r = map[format] || map['1080p'];
  pushUndo();
  state.resolution = r;
  canvas.width = r.w; canvas.height = r.h;
  // little wait for layout
  await new Promise(res => setTimeout(res, 200));
  // prepare streams
  const canvasStream = canvas.captureStream(state.fps);
  let mixedStream = canvasStream;
  if(state.audio && state.audio.element){
    try {
      // create an AudioContext and mix streams (canvas has no audio track, so we only need to capture audio element)
      const audioStream = state.audio.element.captureStream ? state.audio.element.captureStream() : null;
      if(audioStream){
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const dest = ctx.createMediaStreamDestination();
        const src2 = ctx.createMediaStreamSource(audioStream);
        src2.connect(dest);
        mixedStream = new MediaStream([...canvasStream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
      } else {
        // fallback: some browsers don't support captureStream on Audio -> export without audio
        mixedStream = canvasStream;
      }
    } catch(e){
      console.warn('Audio mixing failed', e);
      mixedStream = canvasStream;
    }
  }

  const options = { mimeType: 'video/webm;codecs=vp9' };
  const mr = new MediaRecorder(mixedStream, options);
  const chunks = [];
  mr.ondataavailable = (ev)=>{ if(ev.data && ev.data.size) chunks.push(ev.data); };
  mr.onstop = ()=> {
    const blob = new Blob(chunks, {type:'video/webm'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${state.projectName.replace(/\s+/g,'_')}_${Date.now()}.webm`;
    a.click();
    // restore preview resolution
    state.resolution = {w:1280,h:720};
    canvas.width=state.resolution.w; canvas.height=state.resolution.h;
    renderAll();
  };

  // start audio at 0
  if(state.audio && state.audio.element){
    state.audio.element.currentTime = 0;
    state.audio.element.play();
  }
  mr.start(1000);

  // render frames for duration and stop recorder
  const start = performance.now();
  (function renderExport(now){
    const t = (now - start) / 1000;
    drawFrame(t);
    if(t >= state.duration){
      mr.stop();
      if(state.audio && state.audio.element) state.audio.element.pause();
      return;
    }
    requestAnimationFrame(renderExport);
  })(performance.now());
});

/* ---------- Templates ---------- */
templatesRow.addEventListener('click', (e)=>{
  const t = e.target.dataset.template;
  if(!t) return;
  pushUndo();
  if(t==='birthday'){
    // for demo we will create 3 placeholder image items if available
    if(state.media.length>=3){
      state.timeline = [
        {id:nowId('t'), refId: state.media[0].id, type:state.media[0].type, start:0, duration:3, transition:'fade', filter:'vivid', text:{content:'Joyeux Anniversaire', font:'Poppins', size:56, x:80, y:120}, z:0},
        {id:nowId('t'), refId: state.media[1].id, type:state.media[1].type, start:3, duration:3, transition:'slide', filter:'cinema', text:{content:'C√©l√©bration', font:'Poppins', size:44, x:80, y:500}, z:1},
        {id:nowId('t'), refId: state.media[2].id, type:state.media[2].type, start:6, duration:4, transition:'zoom', filter:'sepia', text:{content:'üéâ', font:'Poppins', size:80, x:1000, y:200}, z:2}
      ];
    } else {
      alert('Ajoute au moins 3 m√©dias dans la biblioth√®que pour utiliser ce template.');
    }
  } else if(t==='travel'){
    if(state.media.length>=2){
      state.timeline = [
        {id:nowId('t'), refId: state.media[0].id, type:state.media[0].type, start:0, duration:4, transition:'slide', filter:'vivid', text:{content:'Voyage', font:'Poppins', size:60, x:60, y:100}, z:0},
        {id:nowId('t'), refId: state.media[1].id, type:state.media[1].type, start:4, duration:5, transition:'fade', filter:'cinema', text:{content:'Aventure', font:'Poppins', size:48, x:60, y:600}, z:1}
      ];
    } else alert('Ajoute au moins 2 m√©dias.');
  } else if(t==='love'){
    if(state.media.length>=2){
      state.timeline = [
        {id:nowId('t'), refId: state.media[0].id, type:state.media[0].type, start:0, duration:4, transition:'fade', filter:'sepia', text:{content:'Notre Histoire', font:'Poppins', size:56, x:80, y:120}, z:0},
        {id:nowId('t'), refId: state.media[1].id, type:state.media[1].type, start:4, duration:4, transition:'zoom', filter:'vivid', text:{content:'üíñ', font:'Poppins', size:80, x:1000, y:300}, z:1}
      ];
    } else alert('Ajoute au moins 2 m√©dias.');
  }
  renderAll();
});

/* ---------- Misc UI actions ---------- */
newProjectBtn.addEventListener('click', ()=>{
  if(!confirm('Nouveau projet ? Tout sera perdu.')) return;
  pushUndo();
  state.media = [];
  state.timeline = [];
  state.audio = null;
  state.selected = null;
  renderAll();
});

/* ---------- Persist (autosave) ---------- */
setInterval(()=>{
  try {
    const payload = {
      projectName: state.projectName,
      media: state.media.map(m=>({id:m.id,type:m.type,url:m.url,duration:m.duration, name: m.file?.name || ''})),
      timeline: state.timeline,
      audio: state.audio?{url:state.audio.url}:null
    };
    localStorage.setItem('capcut_autosave', JSON.stringify(payload));
  } catch(e){}
}, 4000);

// load autosave if exists
(function loadAuto(){
  try {
    const s = localStorage.getItem('capcut_autosave');
    if(!s) return;
    const p = JSON.parse(s);
    state.projectName = p.projectName || state.projectName;
    if(p.media) {
      state.media = p.media.map(m => ({...m, element: new Image()}));
      // NOTE: local cached images may not be accessible cross-session; user may re-upload for full functionality
    }
    state.timeline = p.timeline || [];
    if(p.audio) state.audio = {url:p.audio.url, element:new Audio(p.audio.url)};
    renderAll();
  } catch(e){}
})();

/* ---------- Keyboard shortcuts ---------- */
window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){ e.preventDefault(); state.playing ? pause() : play(); }
  if((e.ctrlKey || e.metaKey) && e.key === 'z'){ e.preventDefault(); undo(); renderAll(); }
  if((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key==='Z'))){ e.preventDefault(); redo(); renderAll(); }
  if(e.key === 'Delete' || e.key === 'Backspace'){ if(state.selected) { pushUndo(); state.timeline = state.timeline.filter(x=>x.id!==state.selected); state.selected=null; renderAll(); } }
});

/* ---------- UI render wrapper ---------- */
function renderAll() {
  // update labels
  projectNameEl.textContent = state.projectName;
  timeLabel.textContent = `${state.playhead.toFixed(2)}s / ${state.duration}s`;
  audioName.textContent = state.audio ? (state.audio.file?.name || state.audio.url) : 'Aucune';
  // ensure all media elements have src set
  state.media.forEach(m=>{
    if(!m.element) {
      m.element = m.type==='video'? document.createElement('video') : new Image();
      m.element.src = m.url;
    }
  });
  // canvas resolution
  canvas.width = state.resolution.w;
  canvas.height = state.resolution.h;

  renderLibrary();
  renderTimeline();
  renderProps();
  // draw current frame at playhead (or static preview)
  drawFrame(state.playhead);
}

/* ---------- initial setup ---------- */
renderAll();

/* ---------- Extra: Click outside to deselect ---------- */
document.body.addEventListener('click', (e)=>{
  if(!e.target.closest('.item')){ state.selected = null; renderAll(); }
});

/* ---------- Final notes in console ---------- */
console.log('Editor ready ‚Äî open editor.html in a modern browser.');

/* ---------- End of file ---------- */
</script>
</body>
</html>