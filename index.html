<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixLab CapCut Web</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#111;color:white;overflow:hidden;}
#editor{position:relative;width:100vw;height:85vh;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#111;}
#image{position:absolute;transform-origin:center center;max-width:none;max-height:none;cursor:grab;}
#crop{position:absolute;border:2px dashed #fff;box-sizing:border-box;touch-action:none;cursor:move;}
.handle{width:16px;height:16px;background:white;border-radius:50%;position:absolute;transform:translate(-50%,-50%);}
.handle.tl{top:0;left:0;}
.handle.tr{top:0;right:0;}
.handle.bl{bottom:0;left:0;}
.handle.br{bottom:0;right:0;}
#tools{position:fixed;bottom:0;left:0;right:0;height:18vh;background:rgba(50,50,50,0.9);display:flex;overflow-x:auto;white-space:nowrap;padding:5px;align-items:center;}
.tool-group{display:flex;gap:8px;padding:0 5px;align-items:center;flex:none;}
button,input[type=range],select,input[type=number]{background:#222;border:none;padding:6px 12px;color:white;border-radius:10px;flex:none;}
input[type=range]{width:80px;}
input[type=number]{width:60px;}
#file{position:fixed;top:10px;left:10px; z-index:20;}
.textLayer{position:absolute;cursor:move;user-select:none;color:white;}
.tool{display:flex;flex-direction:column;align-items:center;gap:2px;}
.label{font-size:12px;text-align:center;}
</style>
</head>
<body>

<input type="file" id="file" accept="image/*">

<div id="editor">
<img id="image">
<div id="crop"><div class="handle tl"></div><div class="handle tr"></div>
<div class="handle bl"></div><div class="handle br"></div></div>
</div>

<div id="tools">
  <!-- Transform -->
  <div class="tool-group">
    <div class="tool"><button id="rotateLeft">⟲</button><div class="label">Rotate ⟲</div></div>
    <div class="tool"><button id="rotateRight">⟳</button><div class="label">Rotate ⟳</div></div>
    <div class="tool"><button id="flipH">⇄</button><div class="label">Flip H</div></div>
    <div class="tool"><button id="flipV">⇅</button><div class="label">Flip V</div></div>
  </div>

  <!-- Filters -->
  <div class="tool-group">
    <div class="tool"><input type="range" id="brightness" min="0" max="200" value="100"><div class="label">Brightness</div></div>
    <div class="tool"><input type="range" id="contrast" min="0" max="200" value="100"><div class="label">Contrast</div></div>
    <div class="tool"><input type="range" id="saturation" min="0" max="200" value="100"><div class="label">Saturation</div></div>
    <div class="tool"><input type="range" id="blur" min="0" max="20" value="0"><div class="label">Blur</div></div>
    <div class="tool"><input type="range" id="hue" min="0" max="360" value="0"><div class="label">Hue</div></div>
    <div class="tool"><select id="filter"><option value="none">Normal</option><option value="grayscale(100%)">B/W</option><option value="sepia(80%)">Sepia</option><option value="invert(100%)">Invert</option></select><div class="label">Filter</div></div>
  </div>

  <!-- Crop personnalisé -->
  <div class="tool-group">
    <div class="tool"><input type="range" id="radius" min="0" max="150" value="0"><div class="label">Border Radius</div></div>
    <div class="tool">
      <select id="cropShape"><option value="rect">Carré</option><option value="16:9">16:9</option><option value="4:3">4:3</option><option value="custom">Personnalisé</option></select>
      <div class="label">Crop</div>
    </div>
    <div class="tool" id="customCropInputs" style="display:none;">
      W: <input type="number" id="customWidth" value="200"> H: <input type="number" id="customHeight" value="200">
    </div>
  </div>

  <!-- Text -->
  <div class="tool-group">
    <div class="tool"><button id="addText">T</button><div class="label">Text</div></div>
  </div>

  <!-- Export -->
  <div class="tool-group">
    <div class="tool"><button id="exportBtn">Export</button><div class="label">Save</div></div>
  </div>
</div>

<script>
const img=document.getElementById("image");
const crop=document.getElementById("crop");
const radiusSlider=document.getElementById("radius");
const brightnessSlider=document.getElementById("brightness");
const contrastSlider=document.getElementById("contrast");
const saturationSlider=document.getElementById("saturation");
const blurSlider=document.getElementById("blur");
const hueSlider=document.getElementById("hue");
const filterSelect=document.getElementById("filter");
const rotateLeftBtn=document.getElementById("rotateLeft");
const rotateRightBtn=document.getElementById("rotateRight");
const flipHBtn=document.getElementById("flipH");
const flipVBtn=document.getElementById("flipV");
const addTextBtn=document.getElementById("addText");
const exportBtn=document.getElementById("exportBtn");
const cropShapeSelect=document.getElementById("cropShape");
const customCropInputs=document.getElementById("customCropInputs");
const customWidthInput=document.getElementById("customWidth");
const customHeightInput=document.getElementById("customHeight");

let imgX=0,imgY=0,scale=1,rotation=0,flipH=1,flipV=1;
let dragging=false,startX=0,startY=0;

// ---------- LOAD IMAGE ----------
document.getElementById("file").onchange=e=>{
    const file=e.target.files[0];
    img.src=URL.createObjectURL(file);
    img.onload=()=>{
        const editor=document.getElementById("editor");
        const ew=editor.clientWidth, eh=editor.clientHeight;
        const w=img.naturalWidth, h=img.naturalHeight;
        let ratio=Math.min(ew/w, eh/h);
        img.style.width=(w*ratio)+'px';
        img.style.height=(h*ratio)+'px';
        imgX=(ew-w*ratio)/2; imgY=(eh-h*ratio)/2;
        img.style.left=imgX+'px'; img.style.top=imgY+'px';
        scale=1; rotation=0; flipH=flipV=1;
        crop.style.left=imgX+'px'; crop.style.top=imgY+'px'; crop.style.width=img.width+'px'; crop.style.height=img.height+'px'; crop.style.borderRadius='0px';
        img.style.filter='brightness(100%) contrast(100%) saturate(100%) blur(0px) hue-rotate(0deg) none';
    }
};

// ---------- DRAG IMAGE ----------
document.addEventListener("mousedown",e=>{if(e.target===img){dragging=true; startX=e.clientX-imgX; startY=e.clientY-imgY;}});
document.addEventListener("mousemove",e=>{if(dragging){imgX=e.clientX-startX; imgY=e.clientY-startY; img.style.left=imgX+'px'; img.style.top=imgY+'px';}});
document.addEventListener("mouseup",()=>dragging=false);

// ---------- TRANSFORM ----------
function updateTransform(){img.style.transform=`scale(${scale}) rotate(${rotation}deg) scaleX(${flipH}) scaleY(${flipV})`;}
rotateLeftBtn.onclick=()=>{rotation-=90; updateTransform();};
rotateRightBtn.onclick=()=>{rotation+=90; updateTransform();};
flipHBtn.onclick=()=>{flipH*=-1; updateTransform();};
flipVBtn.onclick=()=>{flipV*=-1; updateTransform();};

// ---------- FILTERS ----------
function updateFilters(){
    img.style.filter=`brightness(${brightnessSlider.value}%) contrast(${contrastSlider.value}%) saturate(${saturationSlider.value}%) blur(${blurSlider.value}px) hue-rotate(${hueSlider.value}deg) ${filterSelect.value}`;
}
[brightnessSlider,contrastSlider,saturationSlider,blurSlider,hueSlider,filterSelect].forEach(el=>{el.oninput=updateFilters;});

// ---------- BORDER RADIUS ----------
radiusSlider.oninput=()=>crop.style.borderRadius=radiusSlider.value+'px';

// ---------- ADD TEXT ----------
addTextBtn.onclick=()=>{
    const text=prompt("Texte à ajouter"); if(!text) return;
    const t=document.createElement("div"); t.className="textLayer"; t.innerText=text; t.style.left="60px"; t.style.top="60px"; t.style.fontSize="24px"; t.style.color="white"; document.getElementById("editor").appendChild(t);
};

// ---------- CROP SHAPE ----------
cropShapeSelect.onchange=()=>{
    if(cropShapeSelect.value==='custom'){customCropInputs.style.display='flex';}else{customCropInputs.style.display='none';}
    updateCropShape();
};
customWidthInput.oninput=customHeightInput.oninput=updateCropShape;

function updateCropShape(){
    const val=cropShapeSelect.value;
    if(val==='rect'){crop.style.height=crop.offsetWidth+'px'; crop.style.borderRadius='0';}
    else if(val==='16:9'){crop.style.height=(crop.offsetWidth*9/16)+'px'; crop.style.borderRadius='0';}
    else if(val==='4:3'){crop.style.height=(crop.offsetWidth*3/4)+'px'; crop.style.borderRadius='0';}
    else if(val==='custom'){
        crop.style.width=customWidthInput.value+'px';
        crop.style.height=customHeightInput.value+'px';
    }
}

// ---------- EXPORT ----------
exportBtn.onclick=()=>{
    if(!img.src) return alert("Importe d'abord une image !");
    const r=crop.getBoundingClientRect();
    const editorRect=document.getElementById("editor").getBoundingClientRect();
    const canvas=document.createElement("canvas");
    canvas.width=r.width; canvas.height=r.height;
    const ctx=canvas.getContext("2d");

    const offsetX=r.left-editorRect.left;
    const offsetY=r.top-editorRect.top;

    const radius=parseInt(radiusSlider.value);
    if(radius>0 || cropShapeSelect.value==='circle'){
        ctx.beginPath();
        ctx.moveTo(radius,0); ctx.lineTo(canvas.width-radius,0); ctx.quadraticCurveTo(canvas.width,0,canvas.width,radius);
        ctx.lineTo(canvas.width,canvas.height-radius); ctx.quadraticCurveTo(canvas.width,canvas.height,canvas.width-radius,canvas.height);
        ctx.lineTo(radius,canvas.height); ctx.quadraticCurveTo(0,canvas.height,0,canvas.height-radius);
        ctx.lineTo(0,radius); ctx.quadraticCurveTo(0,0,radius,0);
        ctx.closePath(); ctx.clip();
    }

    ctx.save();
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(rotation*Math.PI/180);
    ctx.scale(flipH,flipV);
    ctx.filter=`brightness(${brightnessSlider.value}%) contrast(${contrastSlider.value}%) saturate(${saturationSlider.value}%) blur(${blurSlider.value}px) hue-rotate(${hueSlider.value}deg) ${filterSelect.value}`;
    ctx.drawImage(img,-img.width/2-offsetX,-img.height/2-offsetY,img.width*scale,img.height*scale);
    ctx.restore();

    const link=document.createElement("a");
    link.href=canvas.toDataURL("image/png"); link.download="pixlab.png"; link.click();
};
</script>

</body>
</html>