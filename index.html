<!DOCTYPE html>
<html lang="fr">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixLab - Mobile Editor</title>
<style>
body {
    margin: 0;
    background: #0f0f0f;
    font-family: Arial, sans-serif;
    color: white;
    overflow: hidden;
}

#editor {
    position: fixed;
    inset: 0;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: none;
}

#image {
    position: absolute;
    max-width: none;
    max-height: none;
    transform-origin: center center;
}

#crop {
    position: absolute;
    border: 2px solid white;
    border-radius: 0px;
    box-sizing: border-box;
    touch-action: none;
}

.handle {
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    position: absolute;
    transform: translate(-50%, -50%);
    touch-action: none;
}

.handle.tl { top: 0; left: 0; }
.handle.tr { top: 0; right: 0; }
.handle.bl { bottom: 0; left: 0; }
.handle.br { bottom: 0; right: 0; }

#tools {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #111;
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    border-top: 1px solid #333;
}

button, input[type=range] {
    background: #222;
    border: none;
    padding: 10px 15px;
    color: white;
    border-radius: 10px;
    font-size: 14px;
}

input[type=range] {
    width: 120px;
}
</style>
</head>
<body>

<input type="file" id="file" accept="image/*" style="position:fixed;top:10px;left:10px;z-index:20;" />

<div id="editor">
    <img id="image" />
    <div id="crop">
        <div class="handle tl"></div>
        <div class="handle tr"></div>
        <div class="handle bl"></div>
        <div class="handle br"></div>
    </div>
</div>

<div id="tools">
    <button id="exportBtn">Exporter PNG</button>
    <input type="range" id="radius" min="0" max="150" value="0" title="Border radius">
    <button id="rotateLeft">⟲</button>
    <button id="rotateRight">⟳</button>
</div>

<script>
const img = document.getElementById("image");
const crop = document.getElementById("crop");
const radiusSlider = document.getElementById("radius");
const exportBtn = document.getElementById("exportBtn");
const rotateLeftBtn = document.getElementById("rotateLeft");
const rotateRightBtn = document.getElementById("rotateRight");

let scale = 1, lastDist = 0;
let dragging = false, startX = 0, startY = 0, imgX = 0, imgY = 0;
let rotation = 0;

/* ========= CHARGEMENT IMAGE ========= */
document.getElementById("file").onchange = e => {
    const file = e.target.files[0];
    img.src = URL.createObjectURL(file);
    img.onload = () => {
        scale = 1;
        rotation = 0;
        img.style.left = "0px";
        img.style.top = "0px";
        img.style.transform = `scale(${scale}) rotate(0deg)`;
        crop.style.left = "50px";
        crop.style.top = "50px";
        crop.style.width = "200px";
        crop.style.height = "200px";
        crop.style.borderRadius = "0px";
    };
};

/* ========= PINCH ZOOM ========= */
document.addEventListener("touchmove", e => {
    if (e.touches.length === 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (!lastDist) lastDist = dist;
        scale += (dist - lastDist) * 0.005;
        scale = Math.max(0.3, Math.min(5, scale));
        img.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
        lastDist = dist;
    }
}, { passive: false });

document.addEventListener("touchend", () => lastDist = 0);

/* ========= DRAG IMAGE ========= */
document.addEventListener("touchstart", e => {
    if (e.touches.length === 1) {
        dragging = true;
        startX = e.touches[0].clientX - imgX;
        startY = e.touches[0].clientY - imgY;
    }
});

document.addEventListener("touchmove", e => {
    if (dragging && e.touches.length === 1) {
        imgX = e.touches[0].clientX - startX;
        imgY = e.touches[0].clientY - startY;
        img.style.left = imgX + "px";
        img.style.top = imgY + "px";
    }
});

document.addEventListener("touchend", () => dragging = false);

/* ========= HANDLE RESIZE ========= */
let resizing = false, currentHandle = null;
document.querySelectorAll(".handle").forEach(h => {
    h.addEventListener("touchstart", e => {
        e.stopPropagation();
        resizing = true;
        currentHandle = h;
    });
});

document.addEventListener("touchmove", e => {
    if (!resizing) return;
    const r = crop.getBoundingClientRect();
    const x = e.touches[0].clientX;
    const y = e.touches[0].clientY;

    if (currentHandle.classList.contains("tr")) {
        crop.style.width = (x - r.left) + "px";
        crop.style.height = (r.bottom - y) + "px";
        crop.style.top = y + "px";
    }
    if (currentHandle.classList.contains("tl")) {
        crop.style.width = (r.right - x) + "px";
        crop.style.height = (r.bottom - y) + "px";
        crop.style.left = x + "px";
        crop.style.top = y + "px";
    }
    if (currentHandle.classList.contains("bl")) {
        crop.style.width = (r.right - x) + "px";
        crop.style.height = (y - r.top) + "px";
        crop.style.left = x + "px";
    }
    if (currentHandle.classList.contains("br")) {
        crop.style.width = (x - r.left) + "px";
        crop.style.height = (y - r.top) + "px";
    }
}, { passive: false });

document.addEventListener("touchend", () => resizing = false);

/* ========= BORDER RADIUS ========= */
radiusSlider.oninput = () => {
    crop.style.borderRadius = radiusSlider.value + "px";
};

/* ========= ROTATION ========= */
rotateLeftBtn.onclick = () => {
    rotation -= 90;
    img.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
};
rotateRightBtn.onclick = () => {
    rotation += 90;
    img.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
};

/* ========= EXPORT ========= */
exportBtn.onclick = () => {
    if (!img.src) return alert("Importe d'abord une image !");

    const r = crop.getBoundingClientRect();
    const editorRect = document.getElementById("editor").getBoundingClientRect();
    const canvas = document.createElement("canvas");
    canvas.width = r.width;
    canvas.height = r.height;
    const ctx = canvas.getContext("2d");

    const imgRect = img.getBoundingClientRect();
    const offsetX = r.left - imgRect.left;
    const offsetY = r.top - imgRect.top;

    ctx.save();
    if (radiusSlider.value > 0) {
        ctx.beginPath();
        const radius = parseInt(radiusSlider.value);
        ctx.moveTo(radius, 0);
        ctx.lineTo(r.width - radius, 0);
        ctx.quadraticCurveTo(r.width, 0, r.width, radius);
        ctx.lineTo(r.width, r.height - radius);
        ctx.quadraticCurveTo(r.width, r.height, r.width - radius, r.height);
        ctx.lineTo(radius, r.height);
        ctx.quadraticCurveTo(0, r.height, 0, r.height - radius);
        ctx.lineTo(0, radius);
        ctx.quadraticCurveTo(0, 0, radius, 0);
        ctx.closePath();
        ctx.clip();
    }

    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.rotate(rotation * Math.PI/180);
    ctx.drawImage(img,
        -img.width/2 + offsetX, 
        -img.height/2 + offsetY,
        img.width * scale,
        img.height * scale
    );
    ctx.restore();

    const dataURL = canvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.href = dataURL;
    link.download = "pixlab.png";
    link.click();
};
</script>
</body>
</html>